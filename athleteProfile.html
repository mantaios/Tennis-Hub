<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Athlete Profile</title>
<style>
body {
   background-image: url('clays.jpg');
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  height: 100vh;
  color: #fff;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  margin:0;
  padding:20px;
}
.back-btn {
  background: linear-gradient(145deg, #d2a679, #b8865b);
  color: #fff;
  border: none;
  border-radius: 20px;
  padding: 24px 40px;
  cursor: pointer;
  font-weight: bold;
  margin-bottom: 20px;
  transition: all 0.3s ease;
  font-size: 1.3em;
}
.back-btn:hover :active{ 
  background: linear-gradient(145deg, #b8865b, #d2a679); 
  transform: scale(1.03);
}


.profile-card {
  background-color: #fff; /* λευκό φόντο */
  border-radius: 16px;
  box-shadow: 0 0 20px rgba(0,0,0,0.2);
  padding: 20px;
  max-width: 700px;
  margin: 0 auto;
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
  align-items: center;
}
.profile-photo {
  width: 200px; 
  height: 200px; 
  border-radius: 50%; 
  object-fit: cover; 
  border: 3px solid #b8865b; /* χρυσό/καφέ για frame */
}
.profile-details h1 { color: #b8865b; margin-bottom: 10px; }
.profile-details p { margin: 5px 0; font-size: 1.1rem; color: #3b2f2f; }

.profile-menu {
  display:flex; 
  justify-content:center; 
  gap:25px; 
  margin-top:30px; 
  flex-wrap:wrap;
}
.profile-menu button {
  background-color:#fff; 
  color:#3b2f2f; 
  border:3px solid #b8865b; 
  border-radius:25px;
  padding:20px 40px; 
  cursor:pointer; 
  font-weight:bold; 
  font-size:1.3rem; 
  transition:all 0.3s ease; 
  min-width:160px;
}
.profile-menu button:hover, .profile-menu button.active { 
  background-color:#b8865b; 
  color:#fff; 
  transform: scale(1.1);
}

.matches-container { 
  max-width:900px; 
  margin:20px auto; 
  display:flex; 
  flex-direction:column; 
  gap:20px;
}
.match-card {
  position: relative; /* απαραίτητο για το απόλυτο positioning του κουτιού */
  background:#fff; 
  border-radius:12px; 
  padding:20px; 
  border:1px solid #d2a679; 
  cursor:pointer; 
  transition: transform 0.3s, box-shadow 0.3s;
  font-size: 1.3em;
}
.match-card:hover { 
  transform: translateY(-3px); 
  box-shadow: 0 10px 25px rgba(0,0,0,0.2);
}
.match-header { font-size:1.3em; margin-bottom:8px; color:#b8865b; font-weight:bold; }
.match-info { font-size:0.9em; color:#3b2f2f; margin-bottom:12px; }
.match-score { display:flex; gap:6px; flex-wrap:wrap; margin-bottom:12px; }
.score-set { background:#d2a679; border-radius:12px; padding:6px 12px; min-width:50px; text-align:center; font-weight:bold; color:#fff; }

.stats-container { 
  display:none; 
  background:#f0e6d2; /* ανοιχτό καφέ */ 
  border-radius:12px; 
  padding:15px; 
  margin-top:15px; 
  max-height: 300px; 
  overflow-y: auto;
}
.stats-title { text-align:center; font-weight:bold; color:#b8865b; font-size:1.2em; margin-bottom:10px; }
.stat-row { margin-bottom:20px; }
.stat-label { text-align:center; font-weight:bold; margin-bottom:6px; color:#3b2f2f; font-size:15px; }
.bar-wrapper { display:grid; grid-template-columns:80px 1fr 80px; align-items:center; gap:8px; }
.stat-value { font-size:0.95rem; font-weight:bold; text-align:center; color:#3b2f2f; }
.bar { position:relative; height:22px; background:#d2b48c; border-radius:12px; overflow:hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); }
.bar-fill-left { position:absolute; left:0; top:0; bottom:0; background:#b8865b; border-radius:12px 0 0 12px; }
.bar-fill-right { position:absolute; right:0; top:0; bottom:0; background:#deb887; border-radius:0 12px 12px 0; }
.no-matches { text-align:center; color:#3b2f2f; margin-top:50px; }

/* Στατιστικά στην ενότητα Stats */
.stats-section {
  max-width: 700px;
  margin: 20px auto;
  background-color: #fff; /* λευκό φόντο */
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 0 20px rgba(0,0,0,0.2);
}
.stats-section .stats-title {
  text-align: center;
  font-weight: bold;
  color: #b8865b;
  font-size: 2.4em;
  margin-bottom: 20px;
}
.stats-section .stat-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 12px;
  border-bottom: 1px solid #d2a679;
  font-size: 1.1rem;
}
.stats-section .stat-label { color: #3b2f2f; font-weight: bold; font-size: 1.5em; }
.stats-section .stat-value { color: #3b2f2f; font-weight: bold; font-size: 1.5em; }

.stats-period-buttons {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-bottom: 20px;
  flex-wrap: nowrap;
}
.period-btn {
  background-color: #fff;
  color: #3b2f2f;
  border: 2px solid #b8865b;
  border-radius: 25px;
  padding: 20px 40px;
  cursor: pointer;
  font-weight: bold;
  font-size: 1.4rem;
  transition: all 0.3s ease;
}
.period-btn.active, .period-btn:hover {
  background-color: #b8865b;
  color: #fff;
  transform: scale(1.1);
}
.win-box, .lose-box {
  position: absolute;
  top: 50%;           /* κατακόρυφη μέση */
  right: 20px;        /* λίγο απόσταση από δεξιά */
  transform: translateY(-50%); /* για να είναι ακριβώς στη μέση */
  width: 100px;
  height: 100px;
  border-radius: 12px;
  color: #fff;
  font-weight: bold;
  font-size: 3.4rem;
  display: flex;
  justify-content: center;
  align-items: center;
}

.win-box { background-color: #4CAF50; }  /* πράσινο */
.lose-box { background-color: #f44336; } /* κόκκινο */



/* ATP-Style Rankings Table */
/* Container Rankings */
#rankingsContainer {
  width: 100%;
  max-width: 900px;
  margin: 30px auto;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 8px 25px rgba(0,0,0,0.3);
  background: #1c1c1c;
  display: none; /* αρχικά κρυφό */
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* Table Styling */
#rankingsContainer table {
  width: 100%;
  border-collapse: collapse;
  background: #1c1c1c;
}

/* Table Headers */
#rankingsContainer th {
  padding: 14px 16px;
  text-align: left;
  font-size: 1rem;
  font-weight: 600;
  background: linear-gradient(90deg, #b8865b, #d4af7f);
  color: #fff;
  letter-spacing: 0.5px;
}

/* Table Cells */
#rankingsContainer td {
  padding: 12px 16px;
  font-size: 0.95rem;
  color: #eee;
  border-bottom: 1px solid #333;
}

/* Photo in Table */
#rankingsContainer .athlete-photo-table img {
  width: 50px;
  height: 50px;
  object-fit: cover;
  border-radius: 50%;
  border: 2px solid #b8865b;
}

/* Hover Effect for Rows */
#rankingsContainer tr:hover {
  background: #2a2a2a;
  transition: background 0.3s;
}

/* Rank Column */
#rankingsContainer td:first-child {
  font-weight: bold;
  color: #ffd700;
}

/* Responsive Table for Mobile */
@media screen and (max-width: 600px) {
  #rankingsContainer table, #rankingsContainer thead, #rankingsContainer tbody, #rankingsContainer th, #rankingsContainer td, #rankingsContainer tr {
    display: block;
  }

  #rankingsContainer th {
    display: none;
  }

  #rankingsContainer td {
    position: relative;
    padding-left: 50%;
    border-bottom: 1px solid #444;
  }

  #rankingsContainer td::before {
    content: attr(data-label);
    position: absolute;
    left: 16px;
    top: 12px;
    font-weight: 600;
    color: #b8865b;
  }
}


.athlete-photo-table img {
  width: 50px;
  height: 50px;
  object-fit: cover;
  border-radius: 50%;
  border: 1px solid #007BFF;
}
.no-data {
  text-align: center;
  color: #3b2f2f;  /* ίδιο χρώμα */
  margin-top: 50px;
  font-size: 1.3rem;
  font-weight: bold;
}
.no-matches {
  text-align: center;
  color: #3b2f2f;
  margin-top: 50px;
  font-size: 3.3rem;
  font-weight: bold;
}
.news-card {
  background-color: #fff;
  color: #3b2f2f;
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 0 20px rgba(0,0,0,0.2);
  margin-bottom: 20px;
  font-family: 'Georgia', serif;
}
.news-title {
  font-size: 1.5em;
  font-weight: bold;
  color: #b8865b;
  margin-bottom: 10px;
}
.news-text {
  font-size: 1.1em;
  line-height: 1.4em;
}
#opponentSelect {
  background-color: #ffffff; /* χρυσό-καφέ */
  color: #1c1c1c; /* σκοτεινό κείμενο */
  padding: 10px 15px;
  font-size: 1.1rem;
  border-radius: 12px;
  border: 2px solid #fff;
  cursor: pointer;
  transition: all 0.3s ease;
}


#opponentFilterContainer label {
  color: #ffffff !important;  /* το !important εξασφαλίζει ότι υπερισχύει */
  font-weight: bold;
  font-size: 1.4rem;
}


</style>
</head>
<body>

<button class="back-btn" onclick="window.location.href='athletes.html'">  ← Back</button>
<div id="profileContainer"></div>

<div class="profile-menu">
  <button class="menu-btn " data-section="stats">Statistics</button>
  <button class="menu-btn" data-section="lastMatches">Last Matches</button>
  <div id="opponentFilterContainer" style="text-align:center; margin-bottom:15px; display:none;">
<label for="opponentSelect">Filter by Opponent: </label>

  <select id="opponentSelect" style="padding:10px 15px; font-size:1rem; border-radius:12px; border:2px solid #ffffff;">
    <option value="">All Opponents</option>
  </select>
</div>

 <button id="btnRankings">Rankings</button>
  <button class="menu-btn" data-section="news">News</button>
</div>

<div class="matches-container" id="menuContent"></div>
<div id="rankingsContainer"></div>
<div id="newsContainer" style="display:none; max-width:700px; margin:20px auto;"></div>


<script>
const DEFAULT_PHOTO = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAJYAAACWCAYAAADm7Q...';
let db, currentAthlete;

// --- Load Athlete Profile ---
function loadAthlete() {
  const params = new URLSearchParams(window.location.search);
  const id = params.get('id');
  if(!id) return document.getElementById('profileContainer').innerHTML = '<p>No athlete ID provided.</p>';

  const request = indexedDB.open('AthleteDB', 1);
  request.onsuccess = e => {
    const athleteDB = e.target.result;
    const tx = athleteDB.transaction('athletes','readonly');
    tx.objectStore('athletes').get(id).onsuccess = ev => {
      const athlete = ev.target.result;
      if(!athlete) return document.getElementById('profileContainer').innerHTML = '<p>Athlete not found.</p>';
      currentAthlete = athlete;

      const img = document.createElement('img'); img.className='profile-photo';
      const photoTx = athleteDB.transaction('photos','readonly');
      photoTx.objectStore('photos').get(id).onsuccess = e => { img.src = (e.target.result?.photo || DEFAULT_PHOTO); };

      const details = document.createElement('div'); details.className='profile-details';
      details.innerHTML = `<h1>${athlete.firstName} ${athlete.lastName}</h1>
        <p><strong>Age:</strong> ${athlete.age||'-'}</p>
        <p><strong>Height:</strong> ${athlete.height||'-'} cm</p>
        <p><strong>Country:</strong> ${athlete.origin||'-'}</p>
        <p><strong>Gender:</strong> ${athlete.gender||'-'}</p>
        <p><strong>Handedness:</strong> ${athlete.handedness||'-'}</p>
        <p><strong>Backhand:</strong> ${athlete.backhand||'-'}</p>`;

      const card = document.createElement('div'); card.className='profile-card';
      card.appendChild(img); card.appendChild(details);
      document.getElementById('profileContainer').appendChild(card);
    };
  };
}

// --- Stats Categories ---
const statsCategories = [
  { key: "Άσοι", label: "Aces" },
  { key: "Νταμπλ φολτ", label: "Double Faults" },
  { key: "Νικητές", label: "Winners" },
  { key: "Ατομικά λάθη", label: "Unforced Errors" },
  { key: 'Λάθη υπό πίεση', label: "Forced Errors" },
  { key: "Return Winners", label: "Return Winners" },
  { key: "Return Errors", label: "Return Errors" },
  { key: "Πόντοι με σερβίς", label: "Service Points" },
  { key: "Πόντοι χωρίς σερβίς", label: "Points Without Service" },
  { key: 'Κερδισμένοι Πόντοι', label: 'Points Won' },
  { key: "Ποσοστό 1ου σερβίς", label: "1st Serve Percentage" },
];



// --- New Stats Section with Period Buttons ---
function loadStatsSection() {
  if(!currentAthlete) return;
  const container = document.getElementById('menuContent');
  container.innerHTML = `
    <div class="stats-section">
      <div class="stats-title">Stats</div>
      <div class="stats-period-buttons">
        <button class="period-btn active" data-period="alltime">All-Time</button>
        <button class="period-btn" data-period="today">Today</button>
        <button class="period-btn" data-period="week">Last Week</button>
        <button class="period-btn" data-period="month">Last Month</button>
      </div>
      <div id="statsDisplay"></div>
    </div>
  `;

  const buttons = container.querySelectorAll('.period-btn');
  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      buttons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      if(btn.dataset.period === 'alltime') loadStatsAllTimeSection();
      else loadStatsByPeriod(btn.dataset.period);
    });
  });

  loadStatsAllTimeSection(); // default
}

// --- Load All-Time Stats Section ---
// --- Load All-Time Stats Section with Wins-Losses in one line ---
function loadStatsAllTimeSection() {
  if(!currentAthlete) return;
  const fullName = `${currentAthlete.firstName} ${currentAthlete.lastName}`;
  const statsDisplay = document.getElementById('statsDisplay');
  statsDisplay.innerHTML = `<div class="stats-title">All-Time Stats</div>`;

  const reqDB = indexedDB.open('TennisMatchesDB', 1);
  reqDB.onsuccess = e => {
    const matchDB = e.target.result;
    const tx = matchDB.transaction('matches','readonly');
    tx.objectStore('matches').getAll().onsuccess = ev => {
      const matches = ev.target.result.filter(m => m.players.player1 === fullName || m.players.player2 === fullName);
      
      if(!matches.length) {
statsDisplay.innerHTML += "<p class='no-data'>No matches</p>";
        return; 
      }

      // Matches Played
      const matchesPlayedRow = document.createElement('div');
      matchesPlayedRow.className = 'stat-row';
      matchesPlayedRow.innerHTML = `<div class="stat-label">Matches Played</div>
                                    <div class="stat-value">${matches.length}</div>`;
      statsDisplay.appendChild(matchesPlayedRow);

      // Υπολογισμός στατιστικών
      const totalStats = {};
      statsCategories.forEach(cat => { if(cat.key!=="Ποσοστό 1ου σερβίς") totalStats[cat.key]=0; });
      totalStats['Wins'] = 0;
      totalStats['Losses'] = 0;

      matches.forEach(match => {
        const isPlayer1 = match.players.player1 === fullName;

        statsCategories.forEach(cat => {
          if(cat.key==="Ποσοστό 1ου σερβίς") return;
          const statStr = isPlayer1 ? match.stats.player1[cat.key] : match.stats.player2[cat.key];
          if(!statStr) return;
          totalStats[cat.key] += Number(statStr)||0;
        });

        if(match.winner === fullName) totalStats['Wins'] += 1;
        else if(match.loser === fullName) totalStats['Losses'] += 1;
      });

      // Προβολή Wins-Losses σε μια γραμμή
     // --- Προβολή Wins-Losses σαν 1-1 ---
const winsLossesRow = document.createElement('div');
winsLossesRow.className = 'stat-row';
winsLossesRow.innerHTML = `
  <div class="stat-label">Wins - Losses</div>
  <div class="stat-value">${totalStats['Wins']}-${totalStats['Losses']}</div>`;
statsDisplay.appendChild(winsLossesRow);


      // Προβολή των υπόλοιπων στατιστικών
      Object.keys(totalStats).forEach(key => {
        if(key==='Wins' || key==='Losses') return; // ήδη εμφανίστηκαν
        const row = document.createElement('div');
        row.className='stat-row';
        row.innerHTML = `<div class="stat-label">${statsCategories.find(c=>c.key===key).label}</div>
                         <div class="stat-value">${totalStats[key]}</div>`;
        statsDisplay.appendChild(row);
      });
    };
  };
}

// --- Load Stats by Period with Wins-Losses in one line ---
function loadStatsByPeriod(period) {
  if(!currentAthlete) return;
  const fullName = `${currentAthlete.firstName} ${currentAthlete.lastName}`;
  const statsDisplay = document.getElementById('statsDisplay');
  let title = '';
  if(period==='today') title='Today Stats';
  else if(period==='week') title='Last Week Stats';
  else if(period==='month') title='Last Month Stats';
  statsDisplay.innerHTML = `<div class="stats-title">${title}</div>`;

  const now = new Date();
  const oneDay = 24*60*60*1000;
  const oneWeek = 7 * oneDay;
  const oneMonth = 30 * oneDay;

  const reqDB = indexedDB.open('TennisMatchesDB', 1);
  reqDB.onsuccess = e => {
    const matchDB = e.target.result;
    const tx = matchDB.transaction('matches','readonly');
    tx.objectStore('matches').getAll().onsuccess = ev => {
      let matches = ev.target.result.filter(m => m.players.player1 === fullName || m.players.player2 === fullName);
      matches = matches.filter(match => {
        if(!match.date) return false;
        const matchDate = new Date(match.date);
        const diff = now - matchDate;
        if(period==='today') return diff < oneDay && now.getDate()===matchDate.getDate();
        if(period==='week') return diff <= oneWeek;
        if(period==='month') return diff <= oneMonth;
      });
      if(!matches.length) { 
      statsDisplay.innerHTML += "<p class='no-data'>No matches</p>";
        return; 
      }

      // Matches Played
      const matchesPlayedRow = document.createElement('div');
      matchesPlayedRow.className = 'stat-row';
      matchesPlayedRow.innerHTML = `<div class="stat-label">Matches Played</div>
                                    <div class="stat-value">${matches.length}</div>`;
      statsDisplay.appendChild(matchesPlayedRow);

      // Υπολογισμός στατιστικών
      const totalStats = {};
      statsCategories.forEach(cat => { if(cat.key!=="Ποσοστό 1ου σερβίς") totalStats[cat.key]=0; });
      totalStats['Wins'] = 0;
      totalStats['Losses'] = 0;

      matches.forEach(match => {
        const isPlayer1 = match.players.player1 === fullName;

        statsCategories.forEach(cat => {
          if(cat.key==="Ποσοστό 1ου σερβίς") return;
          const statStr = isPlayer1 ? match.stats.player1[cat.key] : match.stats.player2[cat.key];
          if(!statStr) return;
          totalStats[cat.key] += Number(statStr)||0;
        });

        if(match.winner === fullName) totalStats['Wins'] += 1;
        else if(match.loser === fullName) totalStats['Losses'] += 1;
      });

      // Προβολή Wins-Losses σε μια γραμμή
     // --- Προβολή Wins-Losses σαν 1-1 ---
const winsLossesRow = document.createElement('div');
winsLossesRow.className = 'stat-row';
winsLossesRow.innerHTML = `
  <div class="stat-label">Wins - Losses</div>
  <div class="stat-value">${totalStats['Wins']}-${totalStats['Losses']}</div>`;
statsDisplay.appendChild(winsLossesRow);


      // Προβολή των υπόλοιπων στατιστικών
      Object.keys(totalStats).forEach(key => {
        if(key==='Wins' || key==='Losses') return; // ήδη εμφανίστηκαν
        const row = document.createElement('div');
        row.className='stat-row';
        row.innerHTML = `<div class="stat-label">${statsCategories.find(c=>c.key===key).label}</div>
                         <div class="stat-value">${totalStats[key]}</div>`;
        statsDisplay.appendChild(row);
      });
    };
  };
}



// --- Menu Buttons Updated ---
document.querySelectorAll('.menu-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.menu-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');

    const section = btn.dataset.section;
    if(section==='lastMatches') loadLastMatches();
    else if(section==='stats') loadStatsSection();
    else document.getElementById('menuContent').innerHTML='';
  });
});




function loadLastMatches(selectedOpponent = null) {
  if(!currentAthlete) return;
  const fullName = `${currentAthlete.firstName} ${currentAthlete.lastName}`;
  const container = document.getElementById('menuContent'); 
  container.innerHTML = 'Loading...';

  const reqDB = indexedDB.open('TennisMatchesDB',1);
  reqDB.onsuccess = e => {
    const matchDB = e.target.result;
    const tx = matchDB.transaction('matches','readonly');
    tx.objectStore('matches').getAll().onsuccess = ev => {
      let matches = ev.target.result
        .filter(m => m.players.player1 === fullName || m.players.player2 === fullName)
        .sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

      container.innerHTML = '';

      // --- Dropdown για φιλτράρισμα ---
      const opponentContainer = document.createElement('div');
      opponentContainer.innerHTML = `
        <div id="opponentFilterContainer" style="text-align:center; margin-bottom:15px;">
          <label for="opponentSelect" style="color:#b8865b; font-weight:bold; font-size:1.2rem;">Filter by Opponent: </label>
          <select id="opponentSelect" style="padding:10px 15px; font-size:1rem; border-radius:12px; border:2px solid #b8865b;">
            <option value="">All Opponents</option>
          </select>
        </div>
      `;
      container.appendChild(opponentContainer);

      const select = opponentContainer.querySelector('#opponentSelect');

      // Συλλογή μοναδικών αντιπάλων
      const opponents = [...new Set(matches.map(m => m.players.player1 === fullName ? m.players.player2 : m.players.player1))];
      opponents.forEach(op => {
        const opt = document.createElement('option');
        opt.value = op;
        opt.textContent = op;
        select.appendChild(opt);
      });

      // Αν έχει επιλεγμένο opponent, φιλτράρουμε
      if(selectedOpponent) {
        matches = matches.filter(m => 
          m.players.player1 === selectedOpponent || m.players.player2 === selectedOpponent
        );
        select.value = selectedOpponent;
      }

      // Event listener για αλλαγή dropdown
      select.addEventListener('change', () => {
        const value = select.value || null;
        loadLastMatches(value);
      });

      if(!matches.length){
        container.innerHTML += "<p class='no-matches'>No matches found for this player.</p>";
        return;
      }

      matches.forEach(match => {
        const card = document.createElement('div'); 
        card.className = 'match-card';
        const playerName = fullName;

        card.innerHTML = `
          <div class="match-header">
            ${match.players.player1} vs ${match.players.player2} 
            <span class="${match.winner === playerName ? 'win-box' : 'lose-box'}">
              ${match.winner === playerName ? 'Ν' : 'Η'}
            </span>
          </div>
          <div class="match-info">Date: ${match.date||"N/A"} | Location: ${match.location||"N/A"}</div>
          <div class="match-score">${
            match.scores.player1.map((s,i)=>{
              const p1=s||0, p2=match.scores.player2[i]||0; 
              return (p1||p2)? `<span class="score-set">${p1}-${p2}</span>`:''; 
            }).join('')
          }</div>
          <div class="stats-container"></div>
        `;

        const statsContainer = card.querySelector('.stats-container');

        card.addEventListener('click', e => {
          if(e.target.tagName === 'BUTTON') return;

          const resultBox = card.querySelector('.win-box, .lose-box');

          if(statsContainer.style.display === 'none' || statsContainer.style.display === ''){
            statsContainer.innerHTML = '<div class="stats-title">Stats</div>';

            statsCategories.forEach(cat => {
              const key = cat.key;
              const p1Stats = match.stats.player1;
              const p2Stats = match.stats.player2;

              let leftText, rightText, barLeftPct, barRightPct;

              // === Ποσοστό 1ου σερβίς ===
              if(key === "Ποσοστό 1ου σερβίς") {
                const leftStr = p1Stats[key] ? String(p1Stats[key]) : "0/0";
                const rightStr = p2Stats[key] ? String(p2Stats[key]) : "0/0";
                const leftWon = parseInt(leftStr.trim().split("/")[0]) || 0;
                const rightWon = parseInt(rightStr.trim().split("/")[0]) || 0;
                const total = leftWon + rightWon || 1;
                barLeftPct = Math.round((leftWon / total) * 100);
                barRightPct = 100 - barLeftPct;
                leftText = leftStr;
                rightText = rightStr;
              }

              // === Πόντοι με σερβίς ===
              else if(key === "Πόντοι με σερβίς") {
                const p1Serve = p1Stats["Πόντοι με σερβίς"] || 0;
                const p2Return = p2Stats["Πόντοι χωρίς σερβίς"] || 0;
                const p2Serve = p2Stats["Πόντοι με σερβίς"] || 0;
                const p1Return = p1Stats["Πόντοι χωρίς σερβίς"] || 0;

                const p1Total = p1Serve + p2Return;
                const p1pctInd = p1Total ? Math.round((p1Serve / p1Total) * 100) : 0;
                const p2Total = p2Serve + p1Return;
                const p2pctInd = p2Total ? Math.round((p2Serve / p2Total) * 100) : 0;

                leftText = `${p1Serve}/${p1Total} (${p1pctInd}%)`;
                rightText = `${p2Serve}/${p2Total} (${p2pctInd}%)`;

                const totalForBar = p1Serve + p2Serve;
                barLeftPct = totalForBar ? Math.round((p1Serve / totalForBar) * 100) : 50;
                barRightPct = 100 - barLeftPct;
              }

              // === Πόντοι χωρίς σερβίς ===
              else if(key === "Πόντοι χωρίς σερβίς") {
                const p1Return = p1Stats["Πόντοι χωρίς σερβίς"] || 0;
                const p2Serve = p2Stats["Πόντοι με σερβίς"] || 0;
                const p2Return = p2Stats["Πόντοι χωρίς σερβίς"] || 0;
                const p1Serve = p1Stats["Πόντοι με σερβίς"] || 0;

                const p1Total = p1Return + p2Serve;
                const p1pctInd = p1Total ? Math.round((p1Return / p1Total) * 100) : 0;
                const p2Total = p2Return + p1Serve;
                const p2pctInd = p2Total ? Math.round((p2Return / p2Total) * 100) : 0;

                leftText = `${p1Return}/${p1Total} (${p1pctInd}%)`;
                rightText = `${p2Return}/${p2Total} (${p2pctInd}%)`;

                const totalForBar = p1Return + p2Return;
                barLeftPct = totalForBar ? Math.round((p1Return / totalForBar) * 100) : 50;
                barRightPct = 100 - barLeftPct;
              }

              // === Κερδισμένοι Πόντοι ===
              else if(key === "Κερδισμένοι Πόντοι") {
                const p1Points = p1Stats["Κερδισμένοι Πόντοι"] || 0;
                const p2Points = p2Stats["Κερδισμένοι Πόντοι"] || 0;
                const totalPoints = p1Points + p2Points;
                const p1pct = totalPoints ? Math.round((p1Points / totalPoints) * 100) : 50;
                const p2pct = totalPoints ? Math.round((p2Points / totalPoints) * 100) : 50;

                leftText = `${p1Points}/${totalPoints} (${p1pct}%)`;
                rightText = `${p2Points}/${totalPoints} (${p2pct}%)`;

                barLeftPct = p1pct;
                barRightPct = p2pct;
              }

              // === Υπόλοιπα στατιστικά ===
              else {
                const rawLeftVal = p1Stats[key] || 0;
                const rawRightVal = p2Stats[key] || 0;
                const total = Number(rawLeftVal) + Number(rawRightVal) || 1;
                barLeftPct = Math.round((Number(rawLeftVal) / total) * 100);
                barRightPct = 100 - barLeftPct;
                leftText = rawLeftVal;
                rightText = rawRightVal;
                if(rawLeftVal === 0 && rawRightVal === 0){
                  barLeftPct = 50;
                  barRightPct = 50;
                }
              }

              // Δημιουργία DOM για κάθε στατιστικό
              const row = document.createElement('div'); 
              row.className = 'stat-row';
              row.innerHTML = `
                <div class="stat-label">${cat.label}</div>
                <div class="bar-wrapper">
                  <div class="stat-value">${leftText}</div>
                  <div class="bar">
                    <div class="bar-fill-left" style="width:${barLeftPct}%"></div>
                    <div class="bar-fill-right" style="width:${barRightPct}%"></div>
                  </div>
                  <div class="stat-value">${rightText}</div>
                </div>`;
              statsContainer.appendChild(row);
            });

            statsContainer.style.display = 'block';
            if(resultBox){
              if(!resultBox.dataset.originalDisplay){
                resultBox.dataset.originalDisplay = window.getComputedStyle(resultBox).display;
              }
              resultBox.style.display = 'none';
            }
          } else {
            statsContainer.style.display = 'none';
            if(resultBox){
              resultBox.style.display = resultBox.dataset.originalDisplay || 'inline-flex';
            }
          }
        });

        container.appendChild(card);
      });
    };
  };
}






function loadRankings() {
  const container = document.getElementById('rankingsContainer');
  container.style.display = 'block';

  const reqDB = indexedDB.open('AthleteDB', 1);

  reqDB.onsuccess = e => {
    const db = e.target.result;

    const txAthletes = db.transaction('athletes', 'readonly');
    const athletesStore = txAthletes.objectStore('athletes');

    athletesStore.getAll().onsuccess = ev => {
      const athletes = ev.target.result;

      const txPhotos = db.transaction('photos', 'readonly');
      const photosStore = txPhotos.objectStore('photos');

      photosStore.getAll().onsuccess = photoEvent => {
        const photos = photoEvent.target.result;

        const reqMatchesDB = indexedDB.open('TennisMatchesDB', 1);
        reqMatchesDB.onsuccess = eMatch => {
          const matchDB = eMatch.target.result;
          const txMatches = matchDB.transaction('matches','readonly');
          txMatches.objectStore('matches').getAll().onsuccess = evMatches => {
            const matches = evMatches.target.result;

            // Υπολογισμός στατιστικών για κάθε αθλητή
            athletes.forEach(athlete => {
              const fullName = `${athlete.firstName} ${athlete.lastName}`;
              let played = 0, wins = 0, losses = 0, points = 0;

              matches.forEach(match => {
                if(match.players.player1 === fullName || match.players.player2 === fullName) {
                  played += 1;
                  if(match.winner === fullName) { wins += 1; points += 3; }
                  else if(match.loser === fullName) { losses += 1; points -= 1; }
                }
              });

              athlete.matchesPlayed = played;
              athlete.wins = wins;
              athlete.losses = losses;
              athlete.points = points;
            });

            // Ταξινόμηση με βάση πόντους
            athletes.sort((a,b) => (b.points||0) - (a.points||0));

            // Δημιουργία table
            let tableHTML = `
              <table>
                <thead>
                  <tr>
                    <th>Rank</th>
                    <th>Photo</th>            
                    <th>Name</th>
                    <th>Matches Played</th>
                    <th>Wins-Losses</th>
                    <th>Points</th>
                  </tr>
                </thead>
                <tbody>
            `;

            athletes.forEach((athlete, index) => {
              const photoRecord = photos.find(p => p.id === athlete.id);
              const imgSrc = photoRecord ? photoRecord.photo : 'https://via.placeholder.com/50';
              tableHTML += `
                <tr>
                  <td>${index + 1}</td>
                  <td class="athlete-photo-table"><img src="${imgSrc}" alt="${athlete.firstName} ${athlete.lastName}"></td>
                  <td>${athlete.firstName} ${athlete.lastName}</td>
                  <td>${athlete.matchesPlayed || 0}</td>
                  <td>${athlete.wins || 0}-${athlete.losses || 0}</td>
                  <td>${athlete.points || 0}</td>
                </tr>
              `;
            });

            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;

            if (!athletes.length) {
              container.innerHTML = '<p>Δεν υπάρχουν αθλητές για εμφάνιση.</p>';
            }
          };
        };
      };
    };
  };

  reqDB.onerror = () => {
    container.innerHTML = '<p class="error">Σφάλμα κατά τη φόρτωση των rankings.</p>';
  };
}


// Σύνδεση με κουμπί
document.getElementById('btnRankings').addEventListener('click', loadRankings);


// Κρύβει όλα τα sections
function hideAllSections() {
  document.getElementById('menuContent').style.display = 'none';
  document.getElementById('rankingsContainer').style.display = 'none';
}

// Εμφανίζει μόνο το επιλεγμένο section
function showSection(sectionId) {
  hideAllSections();
  const section = document.getElementById(sectionId);
  if(section) section.style.display = 'block';
}

// Διαχείριση κουμπιών menu
document.querySelectorAll('.menu-btn, #btnRankings').forEach(btn => {
  btn.addEventListener('click', () => {
    // Καθαρίζει την active κλάση
    document.querySelectorAll('.menu-btn, #btnRankings').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    const section = btn.dataset.section || 'rankingsContainer';

    if(section === 'lastMatches') {
      loadLastMatches();
      showSection('menuContent');
      document.getElementById('newsContainer').style.display = 'none';
    } 
    else if(section === 'stats') {
      loadStatsSection();
      showSection('menuContent');
      document.getElementById('newsContainer').style.display = 'none';
    } 
    else if(section === 'rankingsContainer') {
      loadRankings();
      showSection('rankingsContainer');
      document.getElementById('newsContainer').style.display = 'none';
    } 
    else if(section === 'news') {
      document.getElementById('menuContent').style.display = 'none';
      document.getElementById('rankingsContainer').style.display = 'none';
      const newsContainer = document.getElementById('newsContainer');
      newsContainer.style.display = 'block';
      loadNews();
    } 
    else {
      // Για άλλα sections αν υπάρχουν
      showSection('menuContent'); 
      document.getElementById('menuContent').innerHTML = '';
      document.getElementById('newsContainer').style.display = 'none';
    }
  });
});


// Στην αρχή, εμφανίζει μόνο το profile / stats section
window.onload = () => {
  hideAllSections();
  loadStatsSection();
  showSection('menuContent');
};
function loadNews() {
  if(!currentAthlete) return;
  const fullName = `${currentAthlete.firstName} ${currentAthlete.lastName}`;
  const container = document.getElementById('newsContainer');
  container.innerHTML = 'Loading news...';
  container.style.display = 'block';

  const reqDB = indexedDB.open('TennisMatchesDB',1);
  reqDB.onsuccess = e => {
    const matchDB = e.target.result;
    const tx = matchDB.transaction('matches','readonly');
    tx.objectStore('matches').getAll().onsuccess = ev => {
      // Φιλτράρουμε αγώνες με τον τρέχοντα αθλητή
      const matches = ev.target.result
        .filter(m => m.players.player1 === fullName || m.players.player2 === fullName)
        .sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)); // πιο πρόσφατος πρώτος

      container.innerHTML = '';
      if(!matches.length){
        container.innerHTML = "<p class='no-data'>No news available.</p>";
        return;
      }

      matches.forEach(match => {
        const isWinner = match.winner === fullName;
        const headline = isWinner ? `Victory for ${fullName}!` : `Tough loss for ${fullName}`;
        const opponent = match.players.player1 === fullName ? match.players.player2 : match.players.player1;
        const scoreText = match.scores.player1.map((s,i)=>{
          const p1=match.scores.player1[i]||0;
          const p2=match.scores.player2[i]||0;
          return (p1||p2)? `${p1}-${p2}`:'';
        }).filter(x=>x).join(', ');

        const newsCard = document.createElement('div');
        newsCard.className = 'news-card';
        newsCard.innerHTML = `
          <div class="news-title">${headline}</div>
          <div class="news-text">
            ${fullName} ${isWinner ? 'defeated' : 'was defeated by'} ${opponent} on ${match.date||'N/A'} at ${match.location||'N/A'}.
            <br>Score: ${scoreText}
          </div>
        `;
        container.appendChild(newsCard);
      });
    };
  };
}

loadAthlete();
</script>
</body>
</html>
